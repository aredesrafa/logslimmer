import { runLogRecapPipeline } from './log-recap/pipeline.js'
import { setupWorker } from './utils/worker-setup.js'

export async function compressAgentLog(
  inputText = '',
  options = {}
) {
  if (!inputText.trim()) {
    return 'No log provided.'
  }

  try {
    const result = await runLogRecapPipeline(inputText, options)
    return formatLogRecapOutput(result)
  } catch (error) {
    console.error('[worker-logrecap] Compression failed:', error)
    throw error
  }
}

function formatLogRecapOutput(result) {
  const lines = []
  lines.push(result.compressed.trim())
  lines.push('')

  if (result.chunkSummaries?.length) {
    lines.push('## Block Overview\n')
    result.chunkSummaries.slice(0, 5).forEach((summary, idx) => {
      lines.push(`### Chunk ${idx + 1} (${summary.source || 'unknown'})`)
      lines.push(summary.text.trim())
      lines.push('')
    })
  }

  if (result.digest?.files?.length) {
    lines.push('## Monitored Files\n')
    result.digest.files.slice(0, 8).forEach(file => {
      lines.push(`- ${file.path} (${file.status}) â€“ ${file.actions.join(', ')}`)
    })
    lines.push('')
  }

  if (result.digest?.errors?.length) {
    lines.push('## Highlighted Errors\n')
    result.digest.errors.slice(0, 6).forEach(err => {
      lines.push(`- ${err.signature}: ${err.message.substring(0, 120)}${err.message.length > 120 ? '...' : ''}`)
    })
    lines.push('')
  }

  lines.push('---\nGenerated by LogSlimmer')
  return lines.join('\n')
}

setupWorker({
  'compress-agent': compressAgentLog
}, {
  workerName: 'worker-logrecap',
  timeoutMs: 90000
})
